<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	    <meta name="description" content="Probabilitic Models in Javascript">
	    <meta name="author" content="m.zaradzki">

	    <!-- Bootstrap core CSS -->
	    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
	    <!-- Custom styles for this template -->
        <link href="../css/styling.css" rel="stylesheet">
        <link href="../css/favicon.ico" rel="shortcut icon">

		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
		  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
		});
		</script>
		<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
		<!--<p>
		When $a \ne 0$, there are two solutions to \(ax^2 + bx + c = 0\) and they are $$x = {-b \pm \sqrt{b^2-4ac} \over 2a}.$$
		</p>-->
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.3.0/Chart.bundle.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.js"></script>
		<script type="text/javascript" src="../gaussianvectors.js"></script>
		<script type="text/javascript" src="../winnertakeall.js"></script>
		<script type="text/javascript" src="../gmm.js"></script>
		<script type="text/javascript" src="../hmm.js"></script>
		<script type="text/javascript" src="../mnist.js"></script>
        <script type="text/javascript" src="../mnist/mnist_labels.js"></script>

		<script>
			var mnist = new MNIST("../mnist");

            var vec_to_imageurl = function (vec28x28) {
                var G = [];
                for (var r=0; r<28; r++)
                {
                    var row = [];
                    for (var c=0; c<28; c++)
                    {
                        row.push( vec28x28[r*28+c] );
                    }
                    G.push(row);
                }
                var rgbs = numeric.mul([G,G,G], 254.9); // collate G 3x for RGB channels
                return numeric.imageURL(rgbs);
            };

			//var data2;
			var isrunning = false;
			var nbclasses = 20;
            var load_and_step = function () {
                if (isrunning) {
                    /*rbm2.train({
                        lr : 0.6,
                        k : 1, // CD-k.
                        epochs : 10 // 10 iteration each step of this function
                    });*/

                    for (var dgt=0; dgt<10; dgt++) {
                        // test by comparing an original image vs a reconstructed image
                        //var ovec = data2[d];
                        var offset = Math.floor(Math.random()*1000);
                        var didx = labels.indexOf(dgt, 5*3000+offset) - 5*3000;
                        var ovec = mnist.mnistitem(5, didx);
                        var imgurlO = vec_to_imageurl( ovec );
                        //
                        var bestclass;
					    var bestdelta;
					    var bestnorm2 = -1;
					    for (var c=0; c<nbclasses; c++) {
					      	var delta = numeric.sub(ovec, guesses[c]);
					      	var norm2 = numeric.dot(delta, delta);
					      	if ((c==0) || (norm2<bestnorm2)) {
					        	bestclass = c;
					        	bestdelta = delta;
					        	bestnorm2 = norm2;
					      	}
					    }
                        var imgurlR = vec_to_imageurl( guesses[bestclass] )
                        //var rvec = rbm2.reconstruct([ovec,])[0];
                        //var imgurlR = vec_to_imageurl( rvec );
                        //console.log(rbm.sampleHgivenV(v)[0]); // WARNING : get hidden layer probabilities from visible unit.
                        document.getElementById('imgO_'+dgt).setAttribute('src', imgurlO);
                        document.getElementById('imgR_'+dgt).setAttribute('src', imgurlR);
                    }

                    /*var h_index = 10;
                    var h_Ws = [];
                    for (var i=0; i<784; i++) {
                        h_Ws.push( rbm2.W[i][h_index] );
                    }
                    var imgurlHWs = vec_to_imageurl( h_Ws );
                    document.getElementById('imgHWs').setAttribute('src', imgurlHWs);*/
                }
            };

            var start_fun = function() {
                if (mnist.loaded[1] && mnist.loaded[5]) { 
                    console.log('starting!');
                    //
                    $('.loading').hide();
                    $('.loaded').show();
                    //
                    data2 = [];
                    for (var i=10; i<2000; i++) {
                        data2.push( mnist.mnistitem(1, i) );
                    }
                    //
                    guesses = WinnerTakeAll(data2, nbclasses, 0.01, 25000);
                    isrunning = true;
                    //load_and_step();
                    setInterval(load_and_step, 0); // get started
                }
                else {
                    setTimeout(start_fun, 200); // check again in a bit
                }
            };

            $(window).load(function() {
                mnist.load_data_batch(1);
                mnist.load_data_batch(5);
                var data2, guesses;
                start_fun();
            });
		</script>
	</head>
	<body>
		<div class="container">
		<div class="row"><div class="col-md-10 col-md-offset-1">
			<div class="row">
				<div class="page-header">
					<h1>Winner-Take-All algorithm</h1>
				</div>
			</div>
			<div class="row">
				<div>
                    <div class="btn-group" role="group" aria-label="...">
                        <button type="button" class="btn btn-info" onclick="isrunning=true;">Run</button>
                        <button type="button" class="btn btn-danger" onclick="isrunning=false;">Pause</button>
                    </div>
                    <br>
                    <br>
                    <div class="alert alert-warning" role="alert">
                        Note that your browser may freeze as the RBM learns from the image set
                    </div>
				</div>
				<div>
                    <table>
                        <tr>
                            <th>Input to visible unit&nbsp;&nbsp;</th>
                            <th>Reconstructed visible unit&nbsp;&nbsp;</th>
                            <th>Input to visible unit&nbsp;&nbsp;</th>
                            <th>Reconstructed visible unit&nbsp;&nbsp;</th>
                            <th>Input to visible unit&nbsp;&nbsp;</th>
                            <th>Reconstructed visible unit&nbsp;&nbsp;</th>
                        </tr>
                        <tr>
                            <td><img id="imgO_0" width="112" height="112" /></td>
                            <td><img id="imgR_0" width="112" height="112" /></td>
                        </tr>
                        <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
                        <tr>
                            <td><img id="imgO_1" width="112" height="112" /></td>
                            <td><img id="imgR_1" width="112" height="112" /></td>
                            <td><img id="imgO_4" width="112" height="112" /></td>
                            <td><img id="imgR_4" width="112" height="112" /></td>
                            <td><img id="imgO_7" width="112" height="112" /></td>
                            <td><img id="imgR_7" width="112" height="112" /></td>
                        </tr>
                        <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
                        <tr>
                            <td><img id="imgO_2" width="112" height="112" /></td>
                            <td><img id="imgR_2" width="112" height="112" /></td>
                            <td><img id="imgO_5" width="112" height="112" /></td>
                            <td><img id="imgR_5" width="112" height="112" /></td>
                            <td><img id="imgO_8" width="112" height="112" /></td>
                            <td><img id="imgR_8" width="112" height="112" /></td>
                        </tr>
                        <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
                        <tr>
                            <td><img id="imgO_3" width="112" height="112" /></td>
                            <td><img id="imgR_3" width="112" height="112" /></td>
                            <td><img id="imgO_6" width="112" height="112" /></td>
                            <td><img id="imgR_6" width="112" height="112" /></td>
                            <td><img id="imgO_9" width="112" height="112" /></td>
                            <td><img id="imgR_9" width="112" height="112" /></td>
                        </tr>
                    </table>
                </div>
			</div>
		</div></div>
		</div> <!-- /container -->
	</body>
</html>